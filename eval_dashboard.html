<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Summarizer Evaluation Dashboard</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    h2 {
      color: #0078d4;
      border-bottom: 2px solid #0078d4;
      padding-bottom: 5px;
      margin-top: 30px;
    }
    .section {
      margin-bottom: 30px;
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 600;
      color: #555;
    }
    textarea, input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 14px;
    }
    textarea {
      min-height: 150px;
      resize: vertical;
    }
    button {
      background: #0078d4;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-top: 10px;
    }
    button:hover {
      background: #005ea6;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 15px;
    }
    .metric-card {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #0078d4;
    }
    .metric-card h3 {
      margin: 0 0 10px;
      font-size: 14px;
      color: #666;
      text-transform: uppercase;
    }
    .metric-value {
      font-size: 28px;
      font-weight: bold;
      color: #333;
    }
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    .comparison-table th, .comparison-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    .comparison-table th {
      background: #0078d4;
      color: white;
      font-weight: 600;
    }
    .comparison-table tr:nth-child(even) {
      background: #f9f9f9;
    }
    .savings {
      color: #28a745;
      font-weight: bold;
    }
    .cost {
      color: #dc3545;
    }
    .result-box {
      background: #f0f8ff;
      border: 1px solid #0078d4;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      white-space: pre-wrap;
    }
    .alert {
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .alert-info {
      background: #d1ecf1;
      border-left: 4px solid #0c5460;
      color: #0c5460;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä Smart Summarizer Evaluation Dashboard</h1>
    
    <div class="alert alert-info">
      <strong>How to use:</strong> Paste article text, select models to test, and click "Run Evaluation" to analyze summary quality and cost savings from stopword removal.
    </div>

    <!-- Input Section -->
    <div class="section">
      <h2>1. Input Article</h2>
      <label for="articleText">Article Text:</label>
      <textarea id="articleText" placeholder="Paste your article text here..."></textarea>
      
      <label for="testUrl">Article URL (optional, for reference):</label>
      <input type="text" id="testUrl" placeholder="https://example.com/article">
    </div>

    <!-- Model Selection -->
    <div class="section">
      <h2>2. Select Models to Test</h2>
      <div class="grid">
        <div>
          <label>
            <input type="checkbox" id="testDefault" checked> Default (transformers.js)
          </label>
          <select id="defaultModel">
            <option>distilbart-cnn-12-6</option>
            <option>t5-small</option>
            <option>t5-base</option>
          </select>
        </div>
        
        <div>
          <label>
            <input type="checkbox" id="testOllama"> Local (Ollama)
          </label>
          <select id="ollamaModel">
            <option>llama-2-7b</option>
            <option>gemma3:4b</option>
            <option>mistral-7b</option>
          </select>
        </div>
        
        <div>
          <label>
            <input type="checkbox" id="testOpenAI"> OpenAI
          </label>
          <select id="openaiModel">
            <option>gpt-4o-mini</option>
            <option>gpt-4o</option>
            <option>gpt-3.5-turbo</option>
          </select>
          <input type="password" id="openaiKey" placeholder="OpenAI API Key">
        </div>
        
        <div>
          <label>
            <input type="checkbox" id="testClaude"> Claude
          </label>
          <select id="claudeModel">
            <option>claude-3-haiku-20240307</option>
            <option>claude-3-5-sonnet-20241022</option>
          </select>
          <input type="password" id="claudeKey" placeholder="Claude API Key">
        </div>
      </div>
    </div>

    <!-- Run Evaluation -->
    <div class="section">
      <button id="runEval">üöÄ Run Evaluation</button>
      <button id="exportResults">üíæ Export Results (JSON)</button>
      <button id="clearResults">üóëÔ∏è Clear</button>
    </div>

    <!-- Results: Token Analysis -->
    <div class="section" id="tokenSection" style="display:none;">
      <h2>3. Token Analysis & Cost Savings</h2>
      <div class="grid">
        <div class="metric-card">
          <h3>Original Text Tokens</h3>
          <div class="metric-value" id="originalTokens">-</div>
        </div>
        <div class="metric-card">
          <h3>Reduced Text Tokens</h3>
          <div class="metric-value savings" id="reducedTokens">-</div>
        </div>
        <div class="metric-card">
          <h3>Token Reduction</h3>
          <div class="metric-value savings" id="tokenReduction">-</div>
        </div>
        <div class="metric-card">
          <h3>Est. Cost Savings</h3>
          <div class="metric-value savings" id="costSavings">-</div>
        </div>
      </div>
      
      <table class="comparison-table">
        <thead>
          <tr>
            <th>Model</th>
            <th>Input Cost/1M tokens</th>
            <th>Original Cost</th>
            <th>Reduced Cost</th>
            <th>Savings per Request</th>
          </tr>
        </thead>
        <tbody id="costTableBody"></tbody>
      </table>
    </div>

    <!-- Results: Summary Comparison -->
    <div class="section" id="summarySection" style="display:none;">
      <h2>4. Summary Quality Metrics</h2>
      <div class="alert alert-info">
        <strong>Metrics Explained:</strong><br>
        ‚Ä¢ <strong>ROUGE-2 F1:</strong> N-gram overlap (higher = more similar to original, 0-100%)<br>
        ‚Ä¢ <strong>BLEU:</strong> Precision-focused metric (higher = better, 0-100%)<br>
        ‚Ä¢ <strong>Cosine Sim:</strong> Semantic similarity (higher = more similar, 0-100%)<br>
        ‚Ä¢ <strong>Flesch Score:</strong> Readability (0-100, higher = easier to read)<br>
        ‚Ä¢ <strong>Grade Level:</strong> US education grade level needed to understand
      </div>
      
      <table class="comparison-table">
        <thead>
          <tr>
            <th>Model</th>
            <th>Stopwords</th>
            <th>Summary Preview</th>
            <th>ROUGE-2 F1</th>
            <th>BLEU</th>
            <th>Cosine Sim</th>
            <th>Flesch</th>
            <th>Grade</th>
            <th>Time (s)</th>
          </tr>
        </thead>
        <tbody id="summaryTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // Token estimation (rough approximation: 1 token ‚âà 4 chars)
    function estimateTokens(text) {
      return Math.ceil(text.length / 4);
    }

    // ========================================
    // ROUGE-N Score (Recall-Oriented Understudy for Gisting Evaluation)
    // ========================================
    function getNGrams(text, n) {
      const words = text.toLowerCase().match(/\w+/g) || [];
      const ngrams = new Set();
      for (let i = 0; i <= words.length - n; i++) {
        ngrams.add(words.slice(i, i + n).join(' '));
      }
      return ngrams;
    }

    function calculateROUGE(reference, summary, n = 2) {
      const refNgrams = getNGrams(reference, n);
      const sumNgrams = getNGrams(summary, n);
      
      if (refNgrams.size === 0) return 0;
      
      let overlap = 0;
      sumNgrams.forEach(gram => {
        if (refNgrams.has(gram)) overlap++;
      });
      
      const recall = overlap / refNgrams.size;
      const precision = sumNgrams.size > 0 ? overlap / sumNgrams.size : 0;
      const f1 = (precision + recall > 0) ? (2 * precision * recall) / (precision + recall) : 0;
      
      return {
        recall: (recall * 100).toFixed(2),
        precision: (precision * 100).toFixed(2),
        f1: (f1 * 100).toFixed(2)
      };
    }

    // ========================================
    // BLEU Score (BiLingual Evaluation Understudy)
    // ========================================
    function calculateBLEU(reference, candidate, maxN = 4) {
      const refWords = reference.toLowerCase().match(/\w+/g) || [];
      const candWords = candidate.toLowerCase().match(/\w+/g) || [];
      
      if (candWords.length === 0) return 0;
      
      // Brevity penalty
      const bp = candWords.length >= refWords.length ? 1 : 
                 Math.exp(1 - refWords.length / candWords.length);
      
      // Calculate n-gram precisions
      let precisionSum = 0;
      for (let n = 1; n <= maxN; n++) {
        const refNgrams = getNGrams(reference, n);
        const candNgrams = getNGrams(candidate, n);
        
        let matches = 0;
        candNgrams.forEach(gram => {
          if (refNgrams.has(gram)) matches++;
        });
        
        const precision = candNgrams.size > 0 ? matches / candNgrams.size : 0;
        if (precision > 0) {
          precisionSum += Math.log(precision);
        }
      }
      
      const bleu = bp * Math.exp(precisionSum / maxN);
      return (bleu * 100).toFixed(2);
    }

    // ========================================
    // Cosine Similarity (simple word overlap based)
    // ========================================
    function cosineSimilarity(text1, text2) {
      const words1 = text1.toLowerCase().match(/\w+/g) || [];
      const words2 = text2.toLowerCase().match(/\w+/g) || [];
      
      // Create frequency maps
      const freq1 = {};
      const freq2 = {};
      
      words1.forEach(w => freq1[w] = (freq1[w] || 0) + 1);
      words2.forEach(w => freq2[w] = (freq2[w] || 0) + 1);
      
      // Get all unique words
      const allWords = new Set([...words1, ...words2]);
      
      // Calculate dot product and magnitudes
      let dotProduct = 0;
      let mag1 = 0;
      let mag2 = 0;
      
      allWords.forEach(word => {
        const v1 = freq1[word] || 0;
        const v2 = freq2[word] || 0;
        dotProduct += v1 * v2;
        mag1 += v1 * v1;
        mag2 += v2 * v2;
      });
      
      mag1 = Math.sqrt(mag1);
      mag2 = Math.sqrt(mag2);
      
      if (mag1 === 0 || mag2 === 0) return 0;
      
      return ((dotProduct / (mag1 * mag2)) * 100).toFixed(2);
    }

    // ========================================
    // Readability Metrics
    // ========================================
    function calculateReadability(text) {
      const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
      const words = text.match(/\w+/g) || [];
      const syllables = words.reduce((sum, word) => sum + countSyllables(word), 0);
      
      if (sentences.length === 0 || words.length === 0) {
        return { fleschScore: 0, gradeLevel: 0 };
      }
      
      const avgWordsPerSentence = words.length / sentences.length;
      const avgSyllablesPerWord = syllables / words.length;
      
      // Flesch Reading Ease
      const fleschScore = 206.835 - 1.015 * avgWordsPerSentence - 84.6 * avgSyllablesPerWord;
      
      // Flesch-Kincaid Grade Level
      const gradeLevel = 0.39 * avgWordsPerSentence + 11.8 * avgSyllablesPerWord - 15.59;
      
      return {
        fleschScore: Math.max(0, Math.min(100, fleschScore)).toFixed(1),
        gradeLevel: Math.max(0, gradeLevel).toFixed(1)
      };
    }

    function countSyllables(word) {
      word = word.toLowerCase().replace(/[^a-z]/g, '');
      if (word.length <= 3) return 1;
      
      word = word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '');
      word = word.replace(/^y/, '');
      
      const matches = word.match(/[aeiouy]{1,2}/g);
      return matches ? matches.length : 1;
    }

    // Stopword removal (matches extension logic)
    function removeStopwords(text) {
      const stopwordSet = new Set([
        "the","a","an","and","or","of","in","on","for","with","to","by",
        "is","are","was","were","be","been","being",
        "this","that","these","those",
        "it","its","as","at","from","so"
      ]);
      const critical = new Set(["not","but","however","yet","although","because"]);
      
      return text
        .split(/\b/)
        .map(token => {
          const word = token.toLowerCase();
          if (critical.has(word)) return token;
          if (stopwordSet.has(word)) return "";
          return token;
        })
        .join("")
        .replace(/\s+/g, " ")
        .trim();
    }

    // Model pricing (per 1M input tokens)
    const modelPricing = {
      "gpt-4o-mini": 0.15,
      "gpt-4o": 2.50,
      "gpt-3.5-turbo": 0.50,
      "claude-3-haiku-20240307": 0.25,
      "claude-3-5-sonnet-20241022": 3.00,
      "distilbart-cnn-12-6": 0, // Local/free
      "t5-small": 0,
      "t5-base": 0,
      "llama-2-7b": 0,
      "gemma3:4b": 0,
      "mistral-7b": 0
    };

    let results = [];

    document.getElementById("runEval").addEventListener("click", async () => {
      const articleText = document.getElementById("articleText").value.trim();
      if (!articleText) {
        alert("Please paste article text first!");
        return;
      }

      const runButton = document.getElementById("runEval");
      runButton.disabled = true;
      runButton.textContent = "‚è≥ Running evaluation...";

      results = [];
      const reducedText = removeStopwords(articleText);
      
      // Token analysis
      const originalTokens = estimateTokens(articleText);
      const reducedTokens = estimateTokens(reducedText);
      const tokenReduction = originalTokens - reducedTokens;
      const reductionPercent = ((tokenReduction / originalTokens) * 100).toFixed(1);

      document.getElementById("originalTokens").textContent = originalTokens.toLocaleString();
      document.getElementById("reducedTokens").textContent = reducedTokens.toLocaleString();
      document.getElementById("tokenReduction").textContent = `${tokenReduction.toLocaleString()} (${reductionPercent}%)`;
      
      // Show sections
      document.getElementById("tokenSection").style.display = "block";
      document.getElementById("summarySection").style.display = "block";

      // Test each selected model
      const tests = [];
      
      if (document.getElementById("testDefault").checked) {
        const model = document.getElementById("defaultModel").value;
        tests.push({ provider: "transformers.js", model, name: `Default: ${model}` });
      }
      
      if (document.getElementById("testOllama").checked) {
        const model = document.getElementById("ollamaModel").value;
        tests.push({ provider: "Ollama", model, name: `Ollama: ${model}` });
      }
      
      if (document.getElementById("testOpenAI").checked) {
        const model = document.getElementById("openaiModel").value;
        const apiKey = document.getElementById("openaiKey").value;
        if (!apiKey) {
          alert("OpenAI API key required!");
        } else {
          tests.push({ provider: "openai", model, apiKey, name: `OpenAI: ${model}` });
        }
      }
      
      if (document.getElementById("testClaude").checked) {
        const model = document.getElementById("claudeModel").value;
        const apiKey = document.getElementById("claudeKey").value;
        if (!apiKey) {
          alert("Claude API key required!");
        } else {
          tests.push({ provider: "claude", model, apiKey, name: `Claude: ${model}` });
        }
      }

      // Run tests
      const summaryTableBody = document.getElementById("summaryTableBody");
      summaryTableBody.innerHTML = "";

      for (const test of tests) {
        // Test with original text
        const startOrig = Date.now();
        const summaryOrig = await testSummarization(articleText, test);
        const timeOrig = ((Date.now() - startOrig) / 1000).toFixed(2);
        
        // Calculate metrics for original
        const rougeOrig = calculateROUGE(articleText, summaryOrig);
        const bleuOrig = calculateBLEU(articleText, summaryOrig);
        const cosineOrig = cosineSimilarity(articleText, summaryOrig);
        const readabilityOrig = calculateReadability(summaryOrig);
        
        // Test with reduced text
        const startRed = Date.now();
        const summaryRed = await testSummarization(reducedText, test);
        const timeRed = ((Date.now() - startRed) / 1000).toFixed(2);
        
        // Calculate metrics for reduced
        const rougeRed = calculateROUGE(articleText, summaryRed);
        const bleuRed = calculateBLEU(articleText, summaryRed);
        const cosineRed = cosineSimilarity(articleText, summaryRed);
        const readabilityRed = calculateReadability(summaryRed);

        // Add to results
        results.push({
          model: test.name,
          original: {
            summary: summaryOrig,
            time: timeOrig,
            rouge: rougeOrig,
            bleu: bleuOrig,
            cosine: cosineOrig,
            readability: readabilityOrig
          },
          reduced: {
            summary: summaryRed,
            time: timeRed,
            rouge: rougeRed,
            bleu: bleuRed,
            cosine: cosineRed,
            readability: readabilityRed
          }
        });

        // Add rows to table
        const row1 = summaryTableBody.insertRow();
        row1.innerHTML = `
          <td rowspan="2"><strong>${test.name}</strong></td>
          <td>‚ùå No</td>
          <td>${summaryOrig.substring(0, 150)}${summaryOrig.length > 150 ? '...' : ''}</td>
          <td>${rougeOrig.f1}%</td>
          <td>${bleuOrig}%</td>
          <td>${cosineOrig}%</td>
          <td>${readabilityOrig.fleschScore}</td>
          <td>${readabilityOrig.gradeLevel}</td>
          <td>${timeOrig}</td>
        `;
        
        const row2 = summaryTableBody.insertRow();
        row2.innerHTML = `
          <td>‚úÖ Yes</td>
          <td>${summaryRed.substring(0, 150)}${summaryRed.length > 150 ? '...' : ''}</td>
          <td>${rougeRed.f1}%</td>
          <td>${bleuRed}%</td>
          <td>${cosineRed}%</td>
          <td>${readabilityRed.fleschScore}</td>
          <td>${readabilityRed.gradeLevel}</td>
          <td>${timeRed}</td>
        `;
      }

      // Update cost table
      updateCostTable(originalTokens, reducedTokens, tests);

      runButton.disabled = false;
      runButton.textContent = "üöÄ Run Evaluation";
    });

    async function testSummarization(text, config) {
      // This simulates calling your extension's background.js
      // In reality, you'd need to integrate with your extension or mock the APIs
      try {
        // Placeholder - you'll need to actually call your extension's functions
        return `[Summary from ${config.name}] - Replace this with actual API calls`;
      } catch (error) {
        return `Error: ${error.message}`;
      }
    }

    function updateCostTable(originalTokens, reducedTokens, tests) {
      const costTableBody = document.getElementById("costTableBody");
      costTableBody.innerHTML = "";
      
      let totalSavings = 0;

      tests.forEach(test => {
        const price = modelPricing[test.model] || 0;
        const originalCost = (originalTokens / 1000000) * price;
        const reducedCost = (reducedTokens / 1000000) * price;
        const savings = originalCost - reducedCost;
        totalSavings += savings;

        const row = costTableBody.insertRow();
        row.innerHTML = `
          <td><strong>${test.name}</strong></td>
          <td>${price === 0 ? 'Free' : '$' + price.toFixed(2)}</td>
          <td class="cost">$${originalCost.toFixed(6)}</td>
          <td class="cost">$${reducedCost.toFixed(6)}</td>
          <td class="savings">$${savings.toFixed(6)}</td>
        `;
      });

      document.getElementById("costSavings").textContent = `$${totalSavings.toFixed(6)}`;
    }

    // Export results
    document.getElementById("exportResults").addEventListener("click", () => {
      if (results.length === 0) {
        alert("No results to export. Run evaluation first!");
        return;
      }

      const dataStr = JSON.stringify(results, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `evaluation-${Date.now()}.json`;
      link.click();
    });

    // Clear results
    document.getElementById("clearResults").addEventListener("click", () => {
      document.getElementById("articleText").value = "";
      document.getElementById("testUrl").value = "";
      document.getElementById("tokenSection").style.display = "none";
      document.getElementById("summarySection").style.display = "none";
      results = [];
    });
  </script>
</body>
</html>